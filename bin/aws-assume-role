#!/usr/bin/env ruby

require "optparse"
require_relative "../lib/aws_assume_role"

options = {}
optparse = OptionParser.new do |opts|
    options[:config] = "#{ENV['HOME']}/.aws/assume.yaml"
    opts.on("-c", "--config file", "Config file. defaults to" \
                  "~/.aws/assume.yaml.") do |c|
        options[:config] = c
    end

    options[:profile] = false
    opts.on("-p", "--profile name", "Load the credentials for a profile into AWS " \
            "environment variables.") do |c|
        options[:profile] = c
    end

    options[:add] = false
    opts.on("-a", "--add", "Add basic/parent account credentials to keystore" \
            "environment variables. Must provide a profile name") do |c|
        options[:add] = c
    end

    options[:delete] = false
    opts.on("-d", "--delete", "Delete credentials from keystore. Must " \
                  "provide a profile name.") do
        options[:delete] = true
    end

    options[:debug] = false
    opts.on("--debug", "Enable debugging") do
        options[:debug] = true
    end

    options[:verbose] = false
    opts.on("-v", "--verbose", "Get more words") do
        options[:verbose] = true
    end
end

optdata = optparse.parse!

AwsAssumeRole::Profile.logger.level = if options[:debug]
                                          Logger::DEBUG
                                      else
                                          Logger::WARN
                                      end

begin
    AwsAssumeRole::Profile.load_profiles
    AwsAssumeRole::Profile.load_config_file(options[:config])
rescue Errno::ENOENT
    STDERR.puts "No config file at options[:config]. Please create one!"
    exit -1 # rubocop:disable Lint/AmbiguousOperator
end

if options[:profile] != false
    profile = AwsAssumeRole::Profile.get_by_name(options[:profile])

    if options[:delete]
        profile.remove
    elsif options[:add]
        profile.add
    else
        profile.use
    end

    system('env | grep "AWS" | sort') if options[:verbose]
end

unless optdata.empty?
    cmd = optdata.join(" ")
    AwsAssumeRole::Profile.logger.debug "Executing Command '#{cmd}'"
    system(cmd)
end
